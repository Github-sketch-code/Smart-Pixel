<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<!--<link rel="stylesheet" href="navstyle.css"/>-->
		<link rel="stylesheet" href="style.css">
    	<link rel="icon" type="image/png" href="fav.png" size="32x32"/>
    	<title>Light is Power</title>

		<div id="menuToggle">
			<!--
			 Eine Checkbock als Click empfaenger fuer den Menu Button
			-->
			<input type="checkbox" />
			<!--
			 Ein paar Spans fur das Menu
			-->
			<span></span>
			<span></span>
			<span></span>
			<!--
			Menu "in" der Checkbox
			-->
			<ul id="menu">
			  <a href="index.html"><li>Home</li></a>    <!--Hier soll sich Temperatur/Luftfeuchte der RGB Regler : EINE SCHLICHTE SEITE befinden-->
			  <a href="#"><li>Reminder</li></a>
			  <a href="#"><li>Switches</li></a>
			  <a href="#"><li>About</li></a>
			  <a href="#" target="_blank"><li>Support</li></a>
			</ul>
		</div>
		<h1 id="top" style="text-align: center; color:rgb(180, 118, 118);">Micro Rainbow</h1>

		<hr />
	</head>
	<body>
		<div class="container">
		<h2>Color Mixer</h2> <!-- Preview has to overlap to the right to prevent covering the lower containers -->
		<form method="POST" onchange="sendRGB();">
			Farbe
			<br />
			<input id="RGB-Color" type="color" name="RGB-Color"/>			
		</form>
	    </div>

		<hr/>

		<div class="container">
		<h2>Effekte Panel</h2> <!-- Should look more atractive -->
		<!--
		<form method="POST" onchange="sendEffekte();">
			<input type="checkbox" id="EffectIsRunning" name="EffectIsRunning">Run Effect
			<br/>
			<input type="radio" class="Effecte" name="Effekt" id="rainbowSoftBlink" value="rainbowSoftBlink"/>Blink
			<br/>
			<input type="radio" class="Effecte" name="Effekt" id="RainbowCycle" value="RainbowCycle"/>RainbowCycle
			<br/>
			<input type="radio" class="Effecte" name="Effekt" id="ColorWipe" value="ColorWipe"/>ColorWipe
			<br/>
			-->
			<form method="POST" onchange="sendEffekte();">
				<input type="checkbox" id="EffectIsRunning" name="EffectIsRunning">Run Effect
				<br/>
				Chose a effect:
					<select id="Effecte">
						<option value="RainbowCycle">RainbowCycle</option>
						<option value="ColorWipe">ColorWipe</option>
						<option value="rainbowSoftBlink">rainbowSoftBlink</option>
					</select>
			<br/>
			 Effekt Speed
			 <br />
			<input id="EffectSpeed" name="EffektSpeed" type="range" min="1" max="100"/>
		</form>
	    </div>

		<hr/>

		<div class="container">
		<h3>Sensor Panel</h3> <!-- Should look like sensors=> Thermometer, Waterdrop ... -->
		<p>Temperature: <span id="Temperature">%TEMP%</span></p>
		<p>Humidity: <span id="Humidity">%HUM%</span></p>
		</div>
		<hr/>
		

		<div class="container">
		<h3>Smart Switch</h3> <!--It should look like a switch-->
		<form method="POST">
			<input class="button" type="button" onclick="sendRelay();"  id="Relay0" value="%NAME%"/>
		</form>
		</div>

		<hr/>
        
		<div class="container">
		<h2>Motion Detector</h2>  <!--Here should be the running man like Mr. X-->
			<p id="Pir-Sensor" style="text-align: center; color: black; padding-top: 3em; padding-bottom: 3em; background-color:green; border-radius: 0.7em; margin: 0.5em 44%;">%RELAY_NAME%</p>

			<!-- <img src="MotionHand2.png" style="background-color:transparent;" /> -->
			 <!--Background auf rgb(219, 219, 38); aendern wenn getriggert-->
	    </div>

		<hr/>

		<div class="container">
		<h2>Einstellungen</h2>
		<form>
			<table cellpadding="5px">
				<colgroup>
					<col width="30%"/>
					<col width="30%"/>
				</colgroup>
				<tr>
					<td>Eigenes WiFi erzeugen</td>
					<td><input onchange="handleWiFiAccessPointModeCheckbox()"id="WiFiAccessPointMode" type="checkbox" name="WiFiAccessPointMode"/></td>
				</tr>
				<tr>
					<td>WiFi-Name</td>
                    <td><input id="WiFi-Name" type="text" name="WiFi-Name" minlength="8" maxlength="12"/></td>
				</tr>
				<tr>
					<td>WiFi-Passwort</td>
					<td><input id="WiFi-Passwort" type="text" name="WiFi-Passwort" minlength="8" maxlength="20"/></td>
				</tr>
				<tr>
					<td>Hostname/Domain</td>
					<td><input id="Hostname" type="text" name="Hostname" minlength="1" maxlength="12"/></td>
				</tr>
				<tr>
					<td>Anzahl an Clients</td>
					<td><input id="MaxConnections" type="number" min="1" max="8" name="MaxConnections" title="Maximale Anzahl an Clients, die sich mit dem Wlan verbinden koennen(ist nur Einstellbar wenn 'Eigenes WiFi erzeugen' aktiviert ist)"/></td>
				</tr>
				<tr>
					<td>Relay Name</td>
					<td>
						<input type="text" id="RelayName" min="1" max="30">
					</td>
				</tr>
				<tr>
					<td>Pir-Sensor Name</td>
					<td>
						<input type="text" id="PirSensorName" min="1" max="30">
					</td>
				</tr>
				<tr>
					
					<!-- <button onclick="SendWiFiSettings(); return false;">Abschicken</button> -->
				</tr>
			</table>
			<input class="button" type="button" value="Abschicken" onclick="SendWiFiSettings();">
		</form>
      </div>
	<div id="bottom">
		<hr >
		<footer >
			<p>Connected Clients: <span id="NumOfConnectedClients">%NUM%</span></p>
			&copy; By _____ and _____
		</footer>
	</div>
	</body>

	<!-- https://code-boxx.com/submit-form-without-refreshing-page/ -->
	<script>
		const WebsocketKeyValues = {
			RGB_COLOR						: "RGB-Color",
			EFFECT							: "Effect",
			EFFECT_RUNNING					: "EffektRunning",
			EFFECT_SPEED					: "EffectSpeed",
			HUMIDITY						: "Humidity",
			TEMPERATURE						: "Temperature",
			RELAY_STATUS					: "RelayStatus",
			RELAY_NAME						: "RelayName",
			PIR_SENSOR_NAME					: "PirSensorName",
			COMMAND							: "Command",
			PIR_SENSOR_STATUS				: "PirSensorStatus",
			REBOOT							: "reboot",
			CLIENT_ALERT					: "ClientAlert",
			NUM_OF_CONNECTED_CLIENTS		: "NumOfConnectedClients",
			WIFI_NAME						: "WiFiName",
			WIFI_PASSWORD					: "WiFiPassword",
			MAX_CONNECTIONS					: "MaxConnections",
			WIFI_ACCESSPOINT_MODE			: "WiFiAccessPointMode",
			HOSTNAME						: "Hostname",

			// Commands:
			WRITE_CONFIG					: "write-config"
		};
		const Effects = {
			RainbowSoftBlink	: "rainbowSoftBlink",
			RainbowCycle		: "RainbowCycle",
			ColorWipe			: "ColorWipe"
		};
		
		// WebSocket-Initialization
			var Socket = new WebSocket("ws://" + location.hostname + ":81/", ["arduino"]);
			var RelayName;
			var PirSensorName;
			Socket.onopen = function() { console.log("Verbindung " + new Date()); }
			Socket.onclose = function() {
				console.log("WebSocket Verbindung getrennt");
				alert("Verbindung zu Server getrtennt! Daten koennen nicht mehr im Hintergrund aktualisiert werden - Website neuladen(reload)");
			}
			Socket.onerror = function(error) {
				console.log("Websocket Fehler ", error);
				alert("Fehler bei der Verbindung zum Server! Daten koennen nicht im Hintergrund aktualisiert werden - Website neuladen(reload)");
			}

			Socket.onmessage = function (sendData) {
				var splitPosFirst = sendData.data.indexOf(":");
				var splitPosSecond = sendData.data.indexOf(":", splitPosFirst + 1);
				var splitPosLast = sendData.data.lastIndexOf(":");

				var argName = sendData.data.substring(splitPosSecond + 1, splitPosLast);
				var arg = sendData.data.substring(splitPosLast + 1);

				console.log(argName + ':' + arg);
				

				switch (argName) {
					case WebsocketKeyValues.RGB_COLOR: {
						document.getElementById("RGB-Color").value = arg;
						break;
					}
					case WebsocketKeyValues.EFFECT_RUNNING: {
						if(arg == "1" || arg == "true"){
							document.getElementById("EffectIsRunning").checked = true;
						}
						else {
							document.getElementById("EffectIsRunning").checked = false;
						}
						break;
					}
					case WebsocketKeyValues.EFFECT: {
						//document.getElementById(arg).checked = true;
						document.getElementById("Effecte").value = arg;
						break;
					}
					case WebsocketKeyValues.EFFECT_SPEED: {
						document.getElementById("EffectSpeed").value = arg;
						break;
					}
					case WebsocketKeyValues.HUMIDITY: {
						document.getElementById("Humidity").innerHTML = arg;
						break;
					}
					case WebsocketKeyValues.TEMPERATURE: {
						document.getElementById("Temperature").innerHTML = arg;
						break;
					}
					case WebsocketKeyValues.RELAY_STATUS: {
						if(arg == "1") {
							buttonText = " ausschalten";
						} else {
							buttonText = " einschalten";
						}
						document.getElementById("Relay0").value = RelayName + buttonText;
						break;
					}
					case WebsocketKeyValues.RELAY_NAME: {
						RelayName = arg;
						document.getElementById("RelayName").value = RelayName;
						break;
					}
					case WebsocketKeyValues.PIR_SENSOR_NAME: {
						PirSensorName = arg;
						document.getElementById("PirSensorName").value = PirSensorName;
						document.getElementById("Pir-Sensor").innerHTML = PirSensorName;	// the quadrat, which shows the status
						break;
					}
					case WebsocketKeyValues.PIR_SENSOR_STATUS: {
						var color = String;
						if(arg == "1" || arg == "true") {
							color = "red";
						} else {
							color = "green";
						}
						document.getElementById("Pir-Sensor").style.backgroundColor = color;
						break;
					}
					case WebsocketKeyValues.CLIENT_ALERT: {
						alert(arg);
						break;
					}
					case WebsocketKeyValues.NUM_OF_CONNECTED_CLIENTS: {
						document.getElementById("NumOfConnectedClients").innerHTML = arg;
						break;
					}
					case WebsocketKeyValues.WIFI_ACCESSPOINT_MODE: {
						if(arg == "1") {
							document.getElementById("WiFiAccessPointMode").checked = true;
						} else {
							document.getElementById("WiFiAccessPointMode").checked = false;
						}
						// Grey out Field for MaxConnections if not creating WiFiAccessPointMode
						handleWiFiAccessPointModeCheckbox();
						break;
					}
					case WebsocketKeyValues.WIFI_NAME: {
						document.getElementById("WiFi-Name").value = arg;
						break;
					}
					case WebsocketKeyValues.WIFI_PASSWORD: {
						document.getElementById("WiFi-Passwort").value = arg;
						break;
					}
					case WebsocketKeyValues.HOSTNAME: {
						document.getElementById("Hostname").value = arg;
						break;
					}
					case WebsocketKeyValues.MAX_CONNECTIONS: {
						document.getElementById("MaxConnections").value = arg;
						break;
					}
					default: {
						console.log("Error got not supported action: " + argName + ':' + arg);
						break;
					}
				}
			}
		// WebSocket-Initialization

		function websocketSend(argName, arg) {
			var sendString = argName + ":" + arg;
			console.log(sendString);
			Socket.send(sendString);
		}

		function sendRelay() {
			var relays = document.getElementsByClassName("Relay");
			for(var relayToChange of relays) {
			}
			var relayNum = 0;
			websocketSend(WebsocketKeyValues.RELAY_STATUS, "");
		}
		function sendRGB() {
			var rgb = document.getElementById("RGB-Color").value;
			//alert(rgb)
			//console.log("RGB: " + rgb);
			//Socket.send(rgb);
			websocketSend(WebsocketKeyValues.RGB_COLOR, rgb);
		}
		function sendEffekte() {
			// https://www.techiedelight.com/get-value-of-selected-radio-button-javascript/ - 2. JavaScript
			var effectName = document.getElementById("Effecte").value;
			var effectRunning = document.getElementById("EffectIsRunning").checked;
			var effektSpeed = document.getElementById("EffectSpeed").value;

			websocketSend(WebsocketKeyValues.EFFECT_RUNNING, effectRunning == true ? "true" : "false");
			websocketSend(WebsocketKeyValues.EFFECT, effectName);
			websocketSend(WebsocketKeyValues.EFFECT_SPEED, effektSpeed);
		}
		function SendWiFiSettings() {
			var WiFiAccessPointMode = document.getElementById("WiFiAccessPointMode").checked == true ? "1" : "0";
			var WiFiName = document.getElementById("WiFi-Name").value;
			var WiFiPasswort = document.getElementById("WiFi-Passwort").value;
			var Hostname = document.getElementById("Hostname").value;
			var maxConnections = document.getElementById("MaxConnections").value;
			var relayName = document.getElementById("RelayName").value
			var pirSensorName = document.getElementById("PirSensorName").value

			websocketSend(WebsocketKeyValues.WIFI_ACCESSPOINT_MODE,	WiFiAccessPointMode);
			websocketSend(WebsocketKeyValues.WIFI_NAME,				WiFiName);
			websocketSend(WebsocketKeyValues.WIFI_PASSWORD,			WiFiPasswort);
			websocketSend(WebsocketKeyValues.MAX_CONNECTIONS,		maxConnections);
			websocketSend(WebsocketKeyValues.HOSTNAME,				Hostname);
			websocketSend(WebsocketKeyValues.RELAY_NAME,			relayName);
			websocketSend(WebsocketKeyValues.PIR_SENSOR_NAME,		pirSensorName);
			sleep(750);	// Sleep because it sent it before the values above!
			websocketSend(WebsocketKeyValues.COMMAND,				WebsocketKeyValues.WRITE_CONFIG);
		}
		function HideField(ID, Hide) {
			if(Hide == true) {
				document.getElementById(ID).setAttribute("disabled", true);
			}
			else {
				document.getElementById(ID).removeAttribute("disabled");
			}
		}
		function FieldIsHidden(ID) {
			return document.getElementById(ID).getAttribute("disabled") == "true" ? true : false;
		}
		function handleWiFiAccessPointModeCheckbox() {
			if(document.getElementById("WiFiAccessPointMode").checked == true) {
				HideField('MaxConnections', false);
			}
			else {
				HideField('MaxConnections', true);
			}
		}


		// https://www.sitepoint.com/delay-sleep-pause-wait/
		function sleep(milliseconds) {
  			const date = Date.now();
  			let currentDate = null;
  			do {
  				currentDate = Date.now();
  			} while (currentDate - date < milliseconds);
		}

		function versuch() {
			var a = document.getElementById("Versuch");
			alert(a.value);
		}
	</script>
</html>
