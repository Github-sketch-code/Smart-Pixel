<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<!--<link rel="stylesheet" href="navstyle.css"/>-->
    	<link rel="icon" type="image/png" href="fav.png" size="32x32"/>
    	<title>Light is Power</title>

		<div id="menuToggle">
			<!--
			 Eine Checkbock als Click empfaenger fuer den Menu Button
			-->
			<input type="checkbox" />
			<!--
			 Ein paar Spans fur das Menu
			-->
			<span></span>
			<span></span>
			<span></span>
			<!--
			Menu "in" der Checkbox
			-->
			<ul id="menu">
			  <a href="index.html"><li>Home</li></a>    <!--Hier soll sich Temperatur/Luftfeuchte der RGB Regler : EINE SCHLICHTE SEITE befinden-->
			  <a href="#"><li>Reminder</li></a>
			  <a href="#"><li>Switches</li></a>
			  <a href="#"><li>About</li></a>
			  <a href="#" target="_blank"><li>Support</li></a>
			</ul>
		</div>
		<h1 id="top" style="text-align: center; color:rgb(180, 118, 118);">Micro Rainbow</h1>

		<hr />
	</head>
	<body>
		<div class="container">
		<h2>Color Mixer</h2> <!-- Preview has to overlap to the right to prevent covering the lower containers -->
		<form method="POST" onchange="sendRGB();">
			Farbe
			<br />
			<input id="RGB-Color" type="color" name="RGB-Color"/>			
		</form>
	    </div>

		<hr/>

		<div class="container">
		<h2>Effekte Panel</h2> <!-- Should look more atractive -->
		<form method="POST" onchange="sendEffekte();">
			<input type="checkbox" id="EffectIsRunning" name="EffectIsRunning">Run Effect
			<br/>
			<input type="radio" class="Effecte" name="Effekt" id="Blink" value="Blink"/>Blink
			<br/>
			<input type="radio" class="Effecte" name="Effekt" id="RainbowCycle" value="RainbowCycle"/>RainbowCycle
			<br/>
			<input type="radio" class="Effecte" name="Effekt" id="ColorWipe" value="ColorWipe"/>ColorWipe
			<br/>
			 Effekt Speed
			 <br />
			<input id="EffectSpeed" name="EffektSpeed" type="range" min="1" max="100"/>
		</form>
	    </div>

		<hr/>

		<div class="container">
		<h3>Sensor Panel</h3> <!-- Should look like sensors=> Thermometer, Waterdrop ... -->
		<p>Temperature: <span id="Temperature">%TEMP%</span></p>
		<p>Humidity: <span id="Humidity">%HUM%</span></p>
		</div>
		<hr/>
		

		<div class="container">
		<h3>Smart Switch</h3> <!--It should look like a switch-->
		<form method="POST">
			<input class="button" type="button" onclick="sendRelay();"  id="Relay0" value="%NAME%"/>
		</form>
		</div>

		<hr/>
        
		<div class="container">
		<h2>Motion Detector</h2>  <!--Here should be the running man like Mr. X-->
		<form method="POST" onclick="sendPirSensor();">
			<p id="Pir-Sensor" style="height: 5em; width: 5em; background-color:green; border-radius: 0.7em;"></p>
			<!-- <img src="MotionHand2.png" style="background-color:transparent;" /> -->
			 <!--Background auf rgb(219, 219, 38); aendern wenn getriggert-->    <br />
			<input class="button" type="button" name="Reset" value="Reset">
		</form>
	    </div>

		<hr/>

		<div class="container">
		<h2>Einstellungen</h2>
		<form>
			<table cellpadding="5px">
				<colgroup>
					<col width="30%"/>
					<col width="30%"/>
				</colgroup>
				<tr>
					<td>Eigenes WiFi erzeugen</td>
					<td><input onchange="handleWiFiAccessPointModeCheckbox()"id="WiFiAccessPointMode" type="checkbox" name="WiFiAccessPointMode"/></td>
				</tr>
				<tr>
					<td>WiFi-Name</td>
                    <td><input id="WiFi-Name" type="text" name="WiFi-Name" minlength="8" maxlength="12"/></td>
				</tr>
				<tr>
					<td>WiFi-Passwort</td>
					<td><input id="WiFi-Passwort" type="text" name="WiFi-Passwort" minlength="8" maxlength="12"/></td>
				</tr>
				<tr>
					<td>Hostname/Domain</td>
					<td><input id="Hostname" type="text" name="Hostname" minlength="1" maxlength="12"/></td>
				</tr>
				<tr>
					<td>Anzahl an Clients</td>
					<td><input id="MaxConnections" type="number" min="1" max="8" name="MaxConnections" title="Maximale Anzahl an Clients, die sich mit dem Wlan verbinden koennen(ist nur Einstellbar wenn 'Eigenes WiFi erzeugen' aktiviert ist)"/></td>
				</tr>
				<tr></tr>
				<tr>
					
					<!-- <button onclick="SendWiFiSettings(); return false;">Abschicken</button> -->
				</tr>
			</table>
			<input class="button" type="button" value="Abschicken" onclick="SendWiFiSettings();">
		</form>
      </div>
	<div id="bottom">
		<hr >
		<footer >
			<p>Connected Clients: <span id="NumOfConnectedClients">%NUM%</span></p>
			&copy; By _____ and _____
		</footer>
	</div>
	</body>

	<!-- https://code-boxx.com/submit-form-without-refreshing-page/ -->
	<script>
		const WebsocketKeyValues = {
			RGB_COLOR					: "RGB-Color",
			EFFECT						: "Effect",
			EFFECT_RUNNING				: "EffektRunning",
			EFFECT_SPEED				: "EffectSpeed",
			HUMIDITY					: "Humidity",
			TEMPERATURE					: "Temperature",
			RELAY_STATUS				: "RelayStatus",
			RELAY_NAME					: "RelayName",
			WRITE_CONFIG				: "write-config",
			PIR_SENSOR_ACTIVE_REPORT	: "PirSensorActiveReport",
			REBOOT						: "reboot",
			CLIENT_ALERT				: "ClientAlert",
			NUM_OF_CONNECTED_CLIENTS	: "NumOfConnectedClients",
			WIFI_NAME					: "WiFiName",
			WIFI_PASSWORD				: "WiFiPassword",
			MAX_CONNECTIONS				: "MaxConnections",
			WIFI_ACCESSPOINT_MODE		: "WiFiAccessPointMode",
			HOSTNAME					: "Hostname"
		};
		const Effects = {
			Blink			: "Blink",
			RainbowCycle	: "RainbowCycle",
			ColorWipe		: "ColorWipe",
			Noting			: "Nothing"
		};
		
		// WebSocket-Initialization
			var Socket = new WebSocket("ws://" + location.hostname + ":81/", ["arduino"]);
			var RelayName;
			Socket.onopen = function() { console.log("Verbindung " + new Date()); }
			Socket.onclose = function() {
				console.log("WebSocket Verbindung getrennt");
				alert("Verbindung zu Server getrtennt! Daten koennen nicht mehr im Hintergrund aktualisiert werden - Website neuladen(reload)");
			}
			Socket.onerror = function(error) {
				console.log("Websocket Fehler ", error);
				alert("Fehler bei der Verbindung zum Server! Daten koennen nicht im Hintergrund aktualisiert werden - Website neuladen(reload)");
			}

			Socket.onmessage = function (sendData) {
				var splitPosFirst = sendData.data.indexOf(":");
				var splitPosSecond = sendData.data.indexOf(":", splitPosFirst + 1);
				var splitPosLast = sendData.data.lastIndexOf(":");

				var argName = sendData.data.substring(splitPosSecond + 1, splitPosLast);
				var arg = sendData.data.substring(splitPosLast + 1);

				console.log(argName + ':' + arg);
				

				switch (argName) {
					case WebsocketKeyValues.RGB_COLOR: {
						document.getElementById("RGB-Color").value = arg;
						break;
					}
					case WebsocketKeyValues.EFFECT_RUNNING: {
						if(arg == "1" || arg == "true"){
							document.getElementById("EffectIsRunning").checked = true;
						}
						else {
							document.getElementById("EffectIsRunning").checked = false;
						}
						break;
					}
					case WebsocketKeyValues.EFFECT: {
						document.getElementById(arg).checked = arg;
						break;
					}
					case WebsocketKeyValues.EFFECT_SPEED: {
						document.getElementById("EffectSpeed").value = arg;
						break;
					}
					case WebsocketKeyValues.HUMIDITY: {
						document.getElementById("Humidity").innerHTML = arg;
						break;
					}
					case WebsocketKeyValues.TEMPERATURE: {
						document.getElementById("Temperature").innerHTML = arg;
						break;
					}
					case WebsocketKeyValues.RELAY_STATUS: {
						if(arg == "1") {
							buttonText = " ausschalten";
						} else {
							buttonText = " einschalten";
						}
						document.getElementById("Relay0").value = RelayName + buttonText;
						break;
					}
					case WebsocketKeyValues.RELAY_NAME: {
						document.getElementById("Relay0").value = arg;
						RelayName = arg;
						break;
					}
					case WebsocketKeyValues.PIR_SENSOR_ACTIVE_REPORT: {
						var color = String;
						if(arg == 1) {
							color = "red";
						} else {
							color = "green";
						}
						document.getElementById("Pir-Sensor").style.backgroundColor = color;
						break;
					}
					case WebsocketKeyValues.CLIENT_ALERT: {
						alert(arg);
						break;
					}
					case WebsocketKeyValues.NUM_OF_CONNECTED_CLIENTS: {
						document.getElementById("NumOfConnectedClients").innerHTML = arg;
						break;
					}
					case WebsocketKeyValues.WIFI_ACCESSPOINT_MODE: {
						if(arg == "1") {
							document.getElementById("WiFiAccessPointMode").checked = true;
						} else {
							document.getElementById("WiFiAccessPointMode").checked = false;
						}
						// Grey out Field for MaxConnections if not creating WiFiAccessPointMode
						handleWiFiAccessPointModeCheckbox();
						break;
					}
					case WebsocketKeyValues.WIFI_NAME: {
						document.getElementById("WiFi-Name").value = arg;
						break;
					}
					case WebsocketKeyValues.WIFI_PASSWORD: {
						document.getElementById("WiFi-Passwort").value = arg;
						break;
					}
					case WebsocketKeyValues.HOSTNAME: {
						document.getElementById("Hostname").value = arg;
						break;
					}
					case WebsocketKeyValues.MAX_CONNECTIONS: {
						document.getElementById("MaxConnections").value = arg;
						break;
					}
					default: {
						console.log("Error got not supported action: " + argName + ':' + arg);
						break;
					}
				}
			}
		// WebSocket-Initialization

		function websocketSend(argName, arg) {
			var sendString = argName + ":" + arg;
			console.log(sendString);
			Socket.send(sendString);
		}

		function sendRelay() {
			var relays = document.getElementsByClassName("Relay");
			for(var relayToChange of relays) {
			}
			var relayNum = 0;
			websocketSend("RelayStatus", "0");
		}
		function sendPirSensor() {
			websocketSend("PirSensor", "reset");
		}
		function sendRGB() {
			var rgb = document.getElementById("RGB-Color").value;
			//alert(rgb)
			//console.log("RGB: " + rgb);
			//Socket.send(rgb);
			websocketSend("RGB-Color", rgb);
		}
		function sendEffekte() {
			// https://www.techiedelight.com/get-value-of-selected-radio-button-javascript/ - 2. JavaScript
			var radios = document.getElementsByClassName("Effecte");
			for (var checked_radio of radios) {
				if(checked_radio.checked) {
					//alert(checked_radio.value);
					websocketSend(WebsocketKeyValues.EFFECT, checked_radio.value);
				}
			}
			var effectRunning = document.getElementById("EffectIsRunning").checked;
			websocketSend(WebsocketKeyValues.EFFECT_RUNNING, effectRunning == true ? "true" : "false");
			var effektSpeed = document.getElementById("EffectSpeed").value;
			websocketSend(WebsocketKeyValues.EFFECT_SPEED, effektSpeed);
		}
		function SendWiFiSettings() {
			var WiFiAccessPointMode = document.getElementById("WiFiAccessPointMode").checked == true ? "1" : "0";
			var WiFiName = document.getElementById("WiFi-Name").value;
			var WiFiPasswort = document.getElementById("WiFi-Passwort").value;
			var Hostname = document.getElementById("Hostname").value;
			var maxConnections = document.getElementById("MaxConnections").value;

			websocketSend("WiFiAccessPointMode" + WiFiAccessPointMode);
			websocketSend("WiFi-Name", WiFiName);
			websocketSend("WiFi-Passwort", WiFiPasswort);
			websocketSend("MaxConnections", maxConnections);
			websocketSend("Hostname", Hostname);
			websocketSend("Command", "writeSpiffsConfigs");
		}
		function HideField(ID, Hide) {
			if(Hide == true) {
				document.getElementById(ID).setAttribute("disabled", true);
			}
			else {
				document.getElementById(ID).removeAttribute("disabled");
			}
		}
		function FiledIsHidden(ID) {
			return document.getElementById(ID).getAttribute("disabled") == "true" ? true : false;
		}
		function handleWiFiAccessPointModeCheckbox() {
			if(document.getElementById("WiFiAccessPointMode").checked == true) {
				HideField('MaxConnections', false);
			}
			else {
				HideField('MaxConnections', true);
			}
		}
	</script>
</html>
